name: Build macOS

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Godot 4.3
        run: |
          curl -L -o godot.zip https://github.com/godotengine/godot/releases/download/4.3-stable/Godot_v4.3-stable_macos.universal.zip
          unzip godot.zip
          echo "GODOT4_BIN=${{ github.workspace }}/Godot.app/Contents/MacOS/Godot" >> $GITHUB_ENV

      - name: Install Rust nightly
        run: |
          rustup toolchain install nightly
          rustup component add rust-src --toolchain nightly

      - name: Set LLVM path for bindgen
        run: echo "LLVM_PATH=$(brew --prefix llvm)" >> $GITHUB_ENV

      - name: Build release
        run: cargo +nightly build --manifest-path bindings/godot/Cargo.toml --release

      - name: Build debug
        run: cargo +nightly build --manifest-path bindings/godot/Cargo.toml

      - name: Find built libraries
        id: find-libs
        run: |
          echo "=== Current directory ==="
          pwd
          echo "=== Finding all .dylib files ==="
          find . -name "*.dylib" -type f 2>/dev/null
          echo "=== Checking target directory structure ==="
          ls -la target/ 2>/dev/null || echo "No target/ directory"
          ls -la target/release/ 2>/dev/null || echo "No target/release/ directory"
          ls -la target/debug/ 2>/dev/null || echo "No target/debug/ directory"

      - name: Copy binaries
        run: |
          mkdir -p bindings/godot/addons/bobbin/bin
          # Find the actual location of the dylib files
          RELEASE_LIB=$(find . -name "libbobbin_godot.dylib" -path "*/release/*" -type f | head -1)
          DEBUG_LIB=$(find . -name "libbobbin_godot.dylib" -path "*/debug/*" -type f | head -1)
          echo "Release lib: $RELEASE_LIB"
          echo "Debug lib: $DEBUG_LIB"
          cp "$RELEASE_LIB" bindings/godot/addons/bobbin/bin/libbobbin_godot.dylib
          cp "$DEBUG_LIB" bindings/godot/addons/bobbin/bin/libbobbin_godot.debug.dylib

      - name: Upload macOS binaries
        uses: actions/upload-artifact@v4
        with:
          name: macos-binaries
          path: bindings/godot/addons/bobbin/bin/*.dylib
